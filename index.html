<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>運彩獲利計算模板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* CSS for printing only the history section */
        @media print {
            body > *:not(#print-area) { /* Hide all direct children of body except the print area */
                display: none !important;
            }
            #print-area { /* Ensure the print area is visible and takes full width */
                display: block !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            /* Adjust table and text within print area for better print layout */
            #print-area table {
                width: 100%;
                border-collapse: collapse;
            }
            #print-area th, #print-area td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: left;
            }
            #print-area h2 {
                text-align: center;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"; // Added GoogleAuthProvider, signInWithPopup, signOut
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase modules globally for React to access (or pass via context)
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            GoogleAuthProvider, // Expose GoogleAuthProvider
            signInWithPopup,    // Expose signInWithPopup
            signOut,            // Expose signOut
            getFirestore,
            doc,
            getDoc,
            addDoc,
            setDoc,
            updateDoc,
            deleteDoc,
            onSnapshot,
            collection,
            query,
            where,
            getDocs
        };
    </script>

    <script>
        // *** 重要：請將 YOUR_FIREBASE_CONFIG_OBJECT_HERE 替換為您從 Firebase Console 取得的完整配置物件 ***
        // 您可以在 Firebase Console -> 專案設定 -> 「您的應用程式」中找到它。
        // 範例格式：JSON.stringify({ apiKey: "AIzaSyB...", authDomain: "your-project.firebaseapp.com", projectId: "your-project-id", ... })
        const __firebase_config = JSON.stringify({
          apiKey: "AIzaSyADSbeZr04Rxr0Al5jKVY1u5j9dnD2Bfx4", // <-- 請替換為您的實際 API Key
          authDomain: "wds-sport.firebaseapp.com", // <-- 請替換為您的實際 Auth Domain
          projectId: "wds-sport", // <-- 請替換為您的實際 Project ID
          storageBucket: "wds-sport.firebasestorage.app", // <-- 請替換為您的實際 Storage Bucket
          messagingSenderId: "765754214969", // <-- 請替換為您的實際 Sender ID
          appId: "1:765754214969:web:d0b648f04b8526a3019be8", // <-- 請替換為您的實際 App ID
          // measurementId: "YOUR_MEASUREMENT_ID" // 如果有啟用 Google Analytics，請解除註解並替換為您的實際 Measurement ID
        });

        // *** 重要：請自訂一個唯一的應用程式 ID，如果不在 Canvas 環境中運行 ***
        // 這個 ID 必須與您在 Firestore 安全規則中使用的 {appId} 相符。例如："my-betting-app-shared-data"
        const __app_id = "your-custom-app-id-here"; // <-- 請替換為您自訂的 ID，例如 "my-betting-app-2024"

        // 這是 Canvas 環境特有的初始認證 Token。
        // 在您本地運行或使用 GitHub Pages 時，此變數通常保持為空字串或移除。
        // 應用程式會自動回退到匿名登入。
        const __initial_auth_token = ""; 
    </script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        // Main App component for the Sports Betting Profit Calculator
        function App() {
            // Firebase states
            const [db, setDb] = React.useState(null);
            const [auth, setAuth] = React.useState(null);
            const [userId, setUserId] = React.useState(null);
            const [userName, setUserName] = React.useState(null); // User's display name
            const [userEmail, setUserEmail] = React.useState(null); // User's email
            const [isAuthReady, setIsAuthReady] = React.useState(false);
            const [loadingFirebase, setLoadingFirebase] = React.useState(true);

            // App states
            const [betAmount, setBetAmount] = React.useState(''); // 投注金額
            const [odds, setOdds] = React.useState('');           // 賠率
            const [eventType, setEventType] = React.useState(''); // 賽事類型
            const [singleBetResult, setSingleBetResult] = React.useState(null); // 單次投注計算結果 (獲利/虧損)
            const [errorMessage, setErrorMessage] = React.useState(''); // 錯誤訊息
            const [betHistory, setBetHistory] = React.useState([]); // 投注紀錄

            // Date filtering states
            const [startDate, setStartDate] = React.useState(''); // 開始日期
            const [endDate, setEndDate] = React.useState('');     // 結束日期

            // Target profit calculation states
            const [targetProfitAmount, setTargetProfitAmount] = React.useState(''); // 目標獲利金額
            const [requiredBetForTargetProfit, setRequiredBetForTargetProfit] = React.useState(null); // 為達到目標獲利所需投注金額

            // State for confirmation dialog visibility for single delete
            const [showConfirmDeleteDialog, setShowConfirmDeleteDialog] = React.useState(false);
            const [recordToDelete, setRecordToDelete] = React.useState(null); // Stores the ID of the record to delete

            // New: State for editing mode
            const [editingRecordId, setEditingRecordId] = React.useState(null); // Stores the ID of the record being edited

            // Suggestions for single bet loss preview
            const singleBetLossSuggestions = [
                "勝敗乃兵家常事，再接再厲！",
                "不要氣餒，下次會更好！",
                "換個角度思考，或許能找到新的機會！",
                "分析更多資訊，保持冷靜的頭腦！",
                "運氣也是實力的一部分，保持信心！",
                "短期的波動不代表長期趨勢，堅持您的策略！",
                "休息一下，或許能看得更清楚！",
            ];

            // General advice for overall profit
            const generalProfitAdvice = [
                "恭喜您！持續保持良好的策略和紀律。",
                "穩健獲利是長期成功的基石，繼續加油！",
                "您的努力得到了回報，繼續精進！",
                "謹慎管理您的資金，讓獲利持續增長。",
                "祝您財源廣進，好運連連！",
            ];

            // General advice for overall loss
            const generalLossAdvice = [
                "別氣餒，每一次虧損都是學習的機會。",
                "重新檢視您的策略，找出可以改進的地方。",
                "控制風險是首要任務，保護您的本金。",
                "暫時休息一下，讓思緒沉澱再出發。",
                "分析失利原因，避免重蹈覆轍。",
                "調整心態，堅持理性判斷。",
            ];

            // General advice for overall break-even or neutral
            const generalNeutralAdvice = [
                "收支平衡也是一種成功，保持穩定。",
                "持續觀察市場，等待更好的機會。",
                "保持耐心，策略的有效性需要時間驗證。",
                "這是一個穩定的階段，可以考慮微調策略。",
            ];

            // --- Firebase Initialization and Authentication ---
            React.useEffect(() => {
                const initializeFirebase = async () => {
                    try {
                        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                        const app = window.firebase.initializeApp(firebaseConfig);
                        const authInstance = window.firebase.getAuth(app);
                        const dbInstance = window.firebase.getFirestore(app);

                        setAuth(authInstance);
                        setDb(dbInstance);

                        // Listen for auth state changes
                        const unsubscribe = window.firebase.onAuthStateChanged(authInstance, async (user) => {
                            if (user) {
                                setUserId(user.uid);
                                setUserName(user.displayName || user.email || '匿名用戶'); // Use display name, then email, then anonymous
                                setUserEmail(user.email);
                            } else {
                                // If no user, try anonymous sign-in first as a fallback
                                try {
                                    // Only attempt custom token sign-in if token is provided
                                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token !== '') {
                                        await window.firebase.signInWithCustomToken(authInstance, __initial_auth_token);
                                    } else {
                                        await window.firebase.signInAnonymously(authInstance);
                                    }
                                } catch (anonError) {
                                    console.error("Anonymous sign-in failed:", anonError);
                                    setErrorMessage("匿名登入失敗，請檢查 Firebase 認證設定或 API 金鑰。");
                                }
                            }
                            setIsAuthReady(true); // Auth state is known
                            setLoadingFirebase(false); // Firebase is ready
                        });

                        return () => unsubscribe(); // Cleanup auth listener
                    } catch (error) {
                        console.error("Firebase initialization failed:", error);
                        setErrorMessage("Firebase 初始化失敗，請檢查設定。");
                        setLoadingFirebase(false);
                    }
                };

                initializeFirebase();
            }, []); // Run only once on mount

            // --- Google Sign-In Handler ---
            const handleGoogleSignIn = async () => {
                setErrorMessage('');
                if (!auth) {
                    setErrorMessage("認證服務未準備好。");
                    return;
                }
                try {
                    const provider = new window.firebase.GoogleAuthProvider();
                    await window.firebase.signInWithPopup(auth, provider);
                    // User is automatically set by onAuthStateChanged listener
                } catch (error) {
                    console.error("Google Sign-In failed:", error);
                    let msg = "Google 登入失敗。";
                    if (error.code === 'auth/popup-closed-by-user') {
                        msg = "Google 登入視窗已關閉。";
                    } else if (error.code === 'auth/cancelled-popup-request') {
                        msg = "已取消先前的登入請求。";
                    } else if (error.code === 'auth/unauthorized-domain') {
                        msg = "未授權的網域。請在 Firebase Console 中新增您的網域。";
                    }
                    setErrorMessage(msg + " 請檢查 Firebase 認證設定。");
                }
            };

            // --- Sign Out Handler ---
            const handleSignOut = async () => {
                setErrorMessage('');
                if (!auth) {
                    setErrorMessage("認證服務未準備好。");
                    return;
                }
                try {
                    await window.firebase.signOut(auth);
                    setUserId(null);
                    setUserName(null);
                    setUserEmail(null);
                    setBetHistory([]); // Clear history on sign out
                    // Optionally, re-sign in anonymously if desired after explicit sign out
                    // await window.firebase.signInAnonymously(auth);
                } catch (error) {
                    console.error("Sign Out failed:", error);
                    setErrorMessage("登出失敗。");
                }
            };

            // --- Firestore Real-time Data Sync ---
            React.useEffect(() => {
                // Only run if Firebase is initialized, auth state is known, AND userId is available
                if (!db || !isAuthReady || !userId) {
                    // If userId becomes null (e.g., after sign out), clear history
                    if (betHistory.length > 0) {
                        setBetHistory([]);
                    }
                    return;
                }

                let unsubscribe;
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    // Collection path is now user-specific
                    const bettingHistoryCollectionRef = window.firebase.collection(db, `artifacts/${appId}/users/${userId}/bettingHistory`);

                    // Order by timestamp to maintain insertion order
                    // Note: Firestore's `orderBy` can be slow without indexes.
                    // For simplicity, we sort by `id` (which is Date.now() or Firestore doc ID) after fetching.
                    unsubscribe = window.firebase.onSnapshot(bettingHistoryCollectionRef, (snapshot) => {
                        const records = [];
                        snapshot.forEach(doc => {
                            records.push({ id: doc.id, ...doc.data() });
                        });
                        // Sort by original timestamp (id) to ensure consistent order
                        records.sort((a, b) => a.id - b.id);
                        setBetHistory(records);
                    }, (error) => {
                        console.error("Error fetching real-time data:", error);
                        setErrorMessage("無法載入即時投注紀錄。");
                    });

                } catch (error) {
                    console.error("Failed to set up Firestore listener:", error);
                    setErrorMessage("設定資料庫監聽失敗。");
                }

                return () => {
                    if (unsubscribe) unsubscribe(); // Cleanup listener on unmount
                };
            }, [db, isAuthReady, userId]); // Re-run if db, auth state, or userId changes

            // Function to perform instant calculation based on current inputs
            const calculateInstantResults = React.useCallback(() => {
                const parsedBetAmount = parseFloat(betAmount);
                const parsedOdds = parseFloat(odds);
                const parsedTargetProfitAmount = parseFloat(targetProfitAmount);

                // --- Calculate for Single Bet Result (Potential Win) ---
                if (isNaN(parsedBetAmount) || parsedBetAmount <= 0 || isNaN(parsedOdds) || parsedOdds < 1) {
                    setSingleBetResult(null);
                } else {
                    // Only calculate potential profit if won
                    const potentialProfitIfWon = (parsedBetAmount * parsedOdds) - parsedBetAmount;
                    setSingleBetResult(potentialProfitIfWon.toFixed(2));
                }

                // --- Calculate Required Bet for Target Profit ---
                if (isNaN(parsedTargetProfitAmount) || parsedTargetProfitAmount <= 0 || isNaN(parsedOdds) || parsedOdds < 1 || (parsedOdds - 1) <= 0) {
                    setRequiredBetForTargetProfit(null);
                } else {
                    // Formula: Required Bet = Target Profit / (Odds - 1)
                    const requiredBet = parsedTargetProfitAmount / (parsedOdds - 1);
                    setRequiredBetForTargetProfit(requiredBet.toFixed(2));
                }

            }, [betAmount, odds, targetProfitAmount]); // Dependencies adjusted

            // Use useEffect to trigger instant calculation whenever relevant inputs change
            React.useEffect(() => {
                calculateInstantResults();
            }, [betAmount, odds, targetProfitAmount, calculateInstantResults]); // Dependencies adjusted

            // Function to handle adding or updating a record
            const handleSaveRecordButtonClick = async () => {
                setErrorMessage('');
                if (!db || !userId) {
                    setErrorMessage("資料庫未準備好或未登入。請先登入。");
                    return;
                }

                const parsedBetAmount = parseFloat(betAmount);
                const parsedOdds = parseFloat(odds);

                if (isNaN(parsedBetAmount) || parsedBetAmount <= 0) {
                    setErrorMessage('請輸入有效的投注金額 (必須是正數)。');
                    return;
                }
                if (isNaN(parsedOdds) || parsedOdds < 1) {
                    setErrorMessage('請輸入有效的賠率 (必須大於或等於 1)。');
                    return;
                }
                if (eventType.trim() === '') {
                    setErrorMessage('請輸入賽事類型。');
                    return;
                }

                const localDateString = new Date().toISOString().split('T')[0]; // Get current date

                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const collectionRef = window.firebase.collection(db, `artifacts/${appId}/users/${userId}/bettingHistory`);

                    if (editingRecordId) {
                        // Update existing record
                        const docRef = window.firebase.doc(collectionRef, editingRecordId);
                        await window.firebase.updateDoc(docRef, {
                            betAmount: parsedBetAmount,
                            odds: parsedOdds,
                            eventType: eventType.trim(),
                            // outcome, profitLoss, status, timestamp, addedBy, settledBy, settledAt remain unchanged or are updated via updateBetStatus
                        });
                        setErrorMessage("紀錄已成功更新。");
                        setEditingRecordId(null); // Exit editing mode
                    } else {
                        // Add new record
                        await window.firebase.addDoc(collectionRef, {
                            betAmount: parsedBetAmount,
                            odds: parsedOdds,
                            eventType: eventType.trim(),
                            outcome: null,
                            profitLoss: 0,
                            date: localDateString,
                            status: 'pending',
                            timestamp: window.firebase.serverTimestamp ? window.firebase.serverTimestamp() : Date.now(),
                            addedBy: userId,
                        });
                        setErrorMessage("新增紀錄成功。");
                    }

                    // Keep betAmount and odds, clear eventType only for new adds
                    // setBetAmount(''); // Keep value
                    // setOdds(''); // Keep value
                    setEventType(''); // Clear event type
                }
                catch (error) {
                    console.error("Error saving document:", error);
                    setErrorMessage("儲存紀錄失敗。");
                }
            };

            // Function to update the status of a bet in history
            const updateBetStatus = async (id, finalOutcome) => {
                setErrorMessage('');
                if (!db || !userId) {
                    setErrorMessage("資料庫未準備好或未登入。");
                    return;
                }
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    // Document path is user-specific
                    const docRef = window.firebase.doc(db, `artifacts/${appId}/users/${userId}/bettingHistory`, id);
                    const docSnap = await window.firebase.getDoc(docRef);

                    if (docSnap.exists()) {
                        const recordData = docSnap.data();
                        let updatedProfitLoss = 0;
                        if (finalOutcome === 'win') {
                            updatedProfitLoss = (recordData.betAmount * recordData.odds) - recordData.betAmount;
                        } else if (finalOutcome === 'loss') {
                            updatedProfitLoss = -recordData.betAmount;
                        }

                        await window.firebase.updateDoc(docRef, {
                            outcome: finalOutcome,
                            profitLoss: updatedProfitLoss,
                            status: finalOutcome,
                            settledBy: userId, // Record who settled the bet
                            settledAt: window.firebase.serverTimestamp ? window.firebase.serverTimestamp() : Date.now(),
                        });
                    } else {
                        setErrorMessage("找不到該紀錄。");
                    }
                } catch (error) {
                    console.error("Error updating document:", error);
                    setErrorMessage("更新紀錄失敗。");
                }
            };

            // Function to handle editing a record
            const handleEditRecord = (record) => {
                setBetAmount(record.betAmount.toString());
                setOdds(record.odds.toString());
                setEventType(record.eventType);
                setEditingRecordId(record.id);
                setErrorMessage(''); // Clear any previous error messages
                setSingleBetResult(null); // Clear preview result
                setTargetProfitAmount(''); // Clear target profit calculation
                setRequiredBetForTargetProfit(null);
            };

            // Function to cancel editing
            const handleCancelEdit = () => {
                setEditingRecordId(null);
                setBetAmount('');
                setOdds('');
                setEventType('');
                setErrorMessage('');
                setSingleBetResult(null);
                setTargetProfitAmount('');
                setRequiredBetForTargetProfit(null);
            };

            // Function to handle deleting a single record
            const handleDeleteRecord = async () => {
                setErrorMessage('');
                if (!db || !userId || !recordToDelete) {
                    setErrorMessage("無法刪除紀錄，資料庫未準備好或未登入。");
                    setShowConfirmDeleteDialog(false); // Hide dialog
                    setRecordToDelete(null); // Clear pending delete record
                    return;
                }

                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    // Document path is user-specific
                    const docRef = window.firebase.doc(db, `artifacts/${appId}/users/${userId}/bettingHistory`, recordToDelete);
                    await window.firebase.deleteDoc(docRef);
                    
                    setErrorMessage("紀錄已成功刪除。");
                    setShowConfirmDeleteDialog(false); // Hide dialog
                    setRecordToDelete(null); // Clear pending delete record
                } catch (error) {
                    console.error("Error deleting document:", error);
                    setErrorMessage("刪除紀錄失敗。");
                    setShowConfirmDeleteDialog(false); // Hide dialog
                    setRecordToDelete(null); // Clear pending delete record
                }
            };


            // Memoized filtered history based on date range
            const filteredBetHistory = React.useMemo(() => {
                // Filter first, then sort by timestamp (id)
                const filtered = betHistory.filter(record => {
                    const recordDate = new Date(record.date);
                    const start = startDate ? new Date(startDate) : null;
                    const end = endDate ? new Date(endDate) : null;

                    if (end) {
                        end.setHours(23, 59, 59, 999);
                    }

                    const isAfterStartDate = !start || recordDate >= start;
                    const isBeforeEndDate = !end || recordDate <= end;

                    return isAfterStartDate && isBeforeEndDate;
                });
                // Sort by ID (which is timestamp from Date.now() or Firestore doc ID)
                return filtered.sort((a, b) => a.id - b.id); // Display all filtered records, not just last 10
            }, [betHistory, startDate, endDate]);

            // Calculate total profit/loss from the filtered records, only for settled bets
            const totalProfitLossFiltered = filteredBetHistory.reduce((sum, record) => {
                if (record.status === 'win' || record.status === 'loss') {
                    return sum + record.profitLoss;
                }
                return sum;
            }, 0).toFixed(2);

            // Calculate win/loss counts and average win rate from filtered history
            const { totalWins, totalLosses, averageWinRate } = React.useMemo(() => {
                let wins = 0;
                let losses = 0;
                filteredBetHistory.forEach(record => {
                    if (record.status === 'win') {
                        wins++;
                    } else if (record.status === 'loss') {
                        losses++;
                    }
                });
                const totalSettledBets = wins + losses;
                const avgWinRate = totalSettledBets > 0 ? ((wins / totalSettledBets) * 100).toFixed(2) : '0.00';
                return { totalWins: wins, totalLosses: losses, averageWinRate: avgWinRate };
            }, [filteredBetHistory]);

            // Function to reset all input fields and results (local only for shared data)
            const resetFields = () => {
                setBetAmount('');
                setOdds('');
                setEventType(''); // Reset event type
                setSingleBetResult(null);
                setErrorMessage('');
                // Note: betHistory is not cleared here as it's synced from Firestore (shared data)
                setStartDate(''); // Clear date filters
                setEndDate('');   // Clear date filters
                setTargetProfitAmount(''); // Reset target profit input
                setRequiredBetForTargetProfit(null); // Reset required bet for target profit
                setEditingRecordId(null); // Clear editing state
            };

            // Function to export filtered history to CSV
            const exportToCsv = () => {
                if (filteredBetHistory.length === 0) {
                    setErrorMessage('沒有紀錄可以導出。');
                    return;
                }

                const headers = ["日期", "賽事類型", "投注金額", "賠率", "結果", "獲利/虧損"]; // Added 賽事類型
                const csvRows = [];

                // Add headers
                csvRows.push(headers.join(','));

                // Add data rows
                filteredBetHistory.forEach(record => {
                    const row = [
                        record.date,
                        record.eventType, // Added event type
                        record.betAmount,
                        record.odds,
                        record.status === 'pending' ? '待定' : (record.outcome === 'win' ? '贏' : '輸'),
                        record.status === 'pending' ? '待定' : record.profitLoss.toFixed(2)
                    ];
                    csvRows.push(row.join(','));
                });

                // Add the total profit/loss row at the end
                csvRows.push(''); // Add an empty row for separation
                csvRows.push(`篩選後總獲利/虧損:,${totalProfitLossFiltered} NTD`);
                csvRows.push(`總勝場:,${totalWins}`);
                csvRows.push(`總敗場:,${totalLosses}`);
                csvRows.push(`平均勝率:,${averageWinRate}%`);


                const csvString = csvRows.join('\n');
                // Prepend BOM to the CSV string for proper UTF-8 interpretation in Excel
                const blob = new Blob(['\ufeff' + csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `運彩紀錄_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href); // Clean up the URL object
            };

            // Function to trigger browser print for only the history section
            const handlePrintRecordsOnly = () => {
                const printContent = document.getElementById('bet-history-section');
                if (!printContent) {
                    setErrorMessage('找不到投注紀錄區塊進行列印。');
                    return;
                }

                // Construct the HTML content for the new print window
                let printContentHtml = `
                    <!DOCTYPE html>
                    <html lang="zh-TW">
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>投注紀錄列印</title>
                        <style>
                            body { font-family: 'Inter', sans-serif; margin: 20px; }
                            h2 { text-align: center; margin-bottom: 20px; font-size: 1.5em; }
                            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background-color: #f2f2f2; }
                            .profit-text { color: #16A34A; font-weight: bold; } /* green-600 */
                            .loss-text { color: #DC2626; font-weight: bold; } /* red-600 */
                            .blue-text { color: #2563EB; font-weight: bold; } /* blue-600 */
                            .red-text { color: #DC2626; font-weight: bold; } /* red-600 */
                            .outcome-badge {
                                display: inline-block;
                                padding: 4px 8px;
                                border-radius: 9999px;
                                font-weight: 600;
                                font-size: 0.8em;
                                line-height: 1;
                            }
                            .win-badge { background-color: #D1FAE5; color: #065F46; } /* green-100, green-800 */
                            .loss-badge { background-color: #FEE2E2; color: #991B1B; } /* red-100, red-800 */
                        </style>
                        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
                    </head>
                    <body>
                        <h2>投注紀錄</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>日期</th>
                                    <th>賽事類型</th> {/* Added 賽事類型 */}
                                    <th>金額</th>
                                    <th>賠率</th>
                                    <th>結果</th>
                                    <th>獲利/虧損</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredBetHistory.map(record => `
                                    <tr>
                                        <td>${record.date}</td>
                                        <td>${record.eventType}</td> {/* Added event type */}
                                        <td>${record.betAmount}</td>
                                        <td>${record.odds}</td>
                                        <td>
                                            <span class="outcome-badge ${record.status === 'win' ? 'win-badge' : (record.status === 'loss' ? 'loss-badge' : '')}">
                                                ${record.status === 'pending' ? '待定' : (record.outcome === 'win' ? '贏' : '輸')}
                                            </span>
                                        </td>
                                        <td class="${record.status === 'win' ? 'profit-text' : (record.status === 'loss' ? 'loss-text' : '')}">
                                            ${record.status === 'pending' ? '待定' : record.profitLoss.toFixed(2)}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div style="text-align: center; margin-top: 20px; font-size: 1.1em; font-weight: bold;">
                            篩選後總獲利/虧損:
                            <span class="${parseFloat(totalProfitLossFiltered) >= 0 ? 'blue-text' : 'red-text'}">
                                ${totalProfitLossFiltered} NTD
                            </span>
                        </div>
                        <div style="text-align: center; margin-top: 10px; font-size: 1em;">
                            總勝場: ${totalWins} | 總敗場: ${totalLosses} | 平均勝率: ${averageWinRate}%
                        </div>
                        <div style="text-align: center; margin-top: 30px; font-size: 0.8em; color: #6B7280;">
                            威爾設計版權所有
                        </div>
                    </body>
                    </html>
                `;

                const printWindow = window.open('', '_blank', 'width=800,height=600');
                if (printWindow) {
                    printWindow.document.write(printContentHtml);
                    printWindow.document.close(); // Important to close the document for rendering
                    printWindow.focus(); // Focus the new window

                    // Use setTimeout to ensure content is rendered before printing
                    printWindow.onload = () => {
                        printWindow.print();
                        printWindow.close();
                    };
                } else {
                    setErrorMessage('無法開啟列印視窗，請檢查瀏覽器設定或彈出視窗阻擋。');
                }
            };


            return (
                <div className="min-h-screen bg-gradient-to-br from-red-100 to-white flex flex-col items-center justify-center p-4 font-sans">
                    {/* Display loading state */}
                    {loadingFirebase && (
                        <div className="absolute inset-0 bg-gray-200 bg-opacity-75 flex items-center justify-center z-50">
                            <div className="text-gray-800 text-lg font-bold">載入中...</div>
                        </div>
                    )}

                    {/* User Info and Sign-in/Sign-out buttons */}
                    <div className="absolute top-4 left-4 right-4 flex flex-col sm:flex-row justify-between items-start sm:items-center bg-gray-100 text-gray-700 text-xs px-3 py-2 rounded-full shadow-md z-10">
                        {userId ? (
                            <div className="flex items-center">
                                <span className="font-bold mr-1">登入用戶:</span>
                                {userName || userEmail || userId}
                                {userEmail && <span className="ml-2 text-gray-500">({userEmail})</span>}
                            </div>
                        ) : (
                            <span className="font-bold">未登入</span>
                        )}
                        <div className="mt-2 sm:mt-0 flex space-x-2">
                            {userId && !userEmail ? ( // Show Google Sign-in if anonymous
                                <button
                                    onClick={handleGoogleSignIn}
                                    className="bg-blue-500 hover:bg-blue-600 text-white text-xs px-3 py-1 rounded-full transition duration-200"
                                    disabled={loadingFirebase || !isAuthReady}
                                >
                                    Google 登入
                                </button>
                            ) : userId && userEmail ? ( // Show Sign-out if Google user
                                <button
                                    onClick={handleSignOut}
                                    className="bg-red-500 hover:bg-red-600 text-white text-xs px-3 py-1 rounded-full transition duration-200"
                                    disabled={loadingFirebase || !isAuthReady}
                                >
                                    登出
                                </button>
                            ) : ( // Show Google Sign-in if not authenticated at all (or anonymous failed)
                                <button
                                    onClick={handleGoogleSignIn}
                                    className="bg-blue-500 hover:bg-blue-600 text-white text-xs px-3 py-1 rounded-full transition duration-200"
                                    disabled={loadingFirebase || !isAuthReady}
                                >
                                    Google 登入
                                </button>
                            )}
                        </div>
                    </div>


                    {/* Confirmation Dialog for single record delete */}
                    {showConfirmDeleteDialog && recordToDelete && (
                        <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-lg shadow-xl text-center">
                                <p className="text-lg font-semibold mb-4">確定要刪除這筆紀錄嗎？</p>
                                <p className="text-sm text-gray-600 mb-6">此操作無法復原。</p>
                                <div className="flex justify-center space-x-4">
                                    <button
                                        onClick={() => { setShowConfirmDeleteDialog(false); setRecordToDelete(null); }}
                                        className="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-200"
                                    >
                                        取消
                                    </button>
                                    <button
                                        onClick={handleDeleteRecord}
                                        className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200"
                                    >
                                        確認刪除
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}


                    {/* Main container for calculator and history, using flexbox for side-by-side layout */}
                    <div className="flex flex-col md:flex-row md:space-x-8 w-full max-w-7xl mt-20 sm:mt-24"> {/* Adjusted max-w */}

                        {/* Calculator section (left side) */}
                        <div className="bg-white p-8 rounded-xl shadow-2xl w-full md:w-2/5 mb-8 md:mb-0 transform transition-all duration-300 hover:scale-[1.01]"> {/* Adjusted width */}
                            <h1 className="text-3xl font-extrabold text-gray-900 mb-6 text-center">
                                投注
                            </h1>

                            {/* Input field for Bet Amount */}
                            <div className="mb-4">
                                <label htmlFor="betAmount" className="block text-gray-700 text-sm font-semibold mb-2">
                                    投注金額 (NTD):
                                </label>
                                <input
                                    type="number"
                                    id="betAmount"
                                    value={betAmount}
                                    onChange={(e) => setBetAmount(e.target.value)}
                                    placeholder="例如: 1000"
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                />
                            </div>

                            {/* Input field for Odds */}
                            <div className="mb-4">
                                <label htmlFor="odds" className="block text-gray-700 text-sm font-semibold mb-2">
                                    賠率:
                                </label>
                                <input
                                    type="number"
                                    id="odds"
                                    value={odds}
                                    onChange={(e) => setOdds(e.target.value)}
                                    placeholder="請先輸入賠率"
                                    step="0.01" // Allow decimal input for odds
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                />
                            </div>

                            {/* New: Input field for Event Type */}
                            <div className="mb-4">
                                <label htmlFor="eventType" className="block text-gray-700 text-sm font-semibold mb-2">
                                    賽事類型:
                                </label>
                                <input
                                    type="text"
                                    id="eventType"
                                    value={eventType}
                                    onChange={(e) => setEventType(e.target.value)}
                                    placeholder="例如: 足球, 籃球, 棒球"
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                />
                            </div>

                            {/* Error message display */}
                            {errorMessage && (
                                <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4" role="alert">
                                    <span className="block sm:inline">{errorMessage}</span>
                                </div>
                            )}

                            {/* Calculation and Reset buttons */}
                            <div className="flex space-x-4 mb-6">
                                <button
                                    onClick={handleSaveRecordButtonClick} // Changed to handleSaveRecordButtonClick
                                    className="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75"
                                    disabled={loadingFirebase || !isAuthReady || !userId} // Disable if Firebase is not ready
                                >
                                    {editingRecordId ? '更新紀錄' : '新增紀錄'} {/* Dynamic button text */}
                                </button>
                                <button
                                    onClick={resetFields}
                                    className="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75"
                                >
                                    重設
                                </button>
                                {editingRecordId && ( /* Show Cancel button only in editing mode */
                                    <button
                                        onClick={handleCancelEdit}
                                        className="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75 ml-2"
                                    >
                                        取消編輯
                                    </button>
                                )}
                            </div>

                            {/* Display area for the single bet result */}
                            {singleBetResult !== null && (
                                <div className="mt-6 p-6 bg-gray-50 rounded-xl shadow-inner text-center mb-4">
                                    <h2 className="text-xl font-semibold text-gray-700 mb-2">單次投注預覽 (潛在獲利):</h2>
                                    <p className={`text-4xl font-extrabold ${parseFloat(singleBetResult) >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                        {parseFloat(singleBetResult) >= 0 ? '獲利' : '虧損'}: {singleBetResult} NTD
                                    </p>
                                    {parseFloat(singleBetResult) > 0 && (
                                        <p className="text-sm text-gray-600 mt-2">此為若成功，預期之淨獲利。</p>
                                    )}
                                    {parseFloat(singleBetResult) === 0 && ( /* Added specific condition for 0 */
                                        <p className="text-sm text-gray-600 mt-2">此為若成功，預期收支平衡。</p>
                                    )}
                                    {parseFloat(singleBetResult) < 0 && ( /* Specific condition for negative */
                                        <>
                                            <p className="text-sm text-gray-600 mt-2">此為若成功，預期之淨虧損。</p>
                                            <p className="text-sm text-red-500 mt-2 italic">
                                                {singleBetLossSuggestions[Math.floor(Math.random() * singleBetLossSuggestions.length)]}
                                            </p>
                                        </>
                                    )}
                                </div>
                            )}

                            {/* Section for Target Profit Calculation */}
                            <div className="mt-6 p-6 bg-gray-100 rounded-xl shadow-inner text-center">
                                <h2 className="text-xl font-semibold text-gray-800 mb-4">目標獲利所需投注計算</h2>
                                <div className="mb-4">
                                    <label htmlFor="targetProfitAmount" className="block text-gray-700 text-sm font-semibold mb-2">
                                        目標獲利金額 (NTD):
                                    </label>
                                    <input
                                        type="number"
                                        id="targetProfitAmount"
                                        value={targetProfitAmount}
                                        onChange={(e) => setTargetProfitAmount(e.target.value)}
                                        placeholder="例如: 1000"
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                    />
                                </div>
                                {requiredBetForTargetProfit !== null && (
                                    <p className="text-lg font-bold text-gray-800 mt-4">
                                        為達到目標獲利，需投注:
                                        <span className="ml-2 text-purple-600 text-3xl">
                                            {requiredBetForTargetProfit} NTD
                                        </span>
                                    </p>
                                )}
                                {(parseFloat(odds) < 1.01 && targetProfitAmount !== '') && ( // Added a small threshold for odds - 1
                                    <p className="text-red-500 text-sm mt-2">
                                        賠率過低 (接近1)，無法達到目標獲利，或需投注極大金額。
                                    </p>
                                )}
                            </div>

                        </div>

                        {/* Display area for the last 10 records (right side) */}
                        <div id="bet-history-section" className="bg-white p-8 rounded-xl shadow-2xl w-full md:w-3/5 overflow-y-auto max-h-[85vh] min-h-[200px]"> {/* Adjusted width and height */}
                            <h2 className="text-xl font-extrabold text-gray-900 mb-4 text-center">投注紀錄</h2>

                            {/* Date filter inputs and Export/Print buttons */}
                            <div className="mb-4 flex flex-col sm:flex-row sm:space-x-4 items-end"> {/* Align items to bottom for button */}
                                <div className="flex-1 mb-4 sm:mb-0">
                                    <label htmlFor="startDate" className="block text-gray-700 text-sm font-semibold mb-2">
                                        開始日期:
                                    </label>
                                    <input
                                        type="date"
                                        id="startDate"
                                        value={startDate}
                                        onChange={(e) => setStartDate(e.target.value)}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                    />
                                </div>
                                <div className="flex-1 mb-4 sm:mb-0">
                                    <label htmlFor="endDate" className="block text-gray-700 text-sm font-semibold mb-2">
                                        結束日期:
                                    </label>
                                    <input
                                        type="date"
                                        id="endDate"
                                        value={endDate}
                                        onChange={(e) => setEndDate(e.target.value)}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                    />
                                </div>
                                <button
                                    onClick={exportToCsv}
                                    className="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75 mb-2 sm:mb-0"
                                >
                                    導出紀錄
                                </button>
                                <button
                                    onClick={handlePrintRecordsOnly}
                                    className="w-full sm:w-auto bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75"
                                >
                                    列印紀錄
                                </button>
                            </div>

                            {filteredBetHistory.length > 0 ? (
                                <>
                                    <div className="overflow-x-auto">
                                        <table className="min-w-full bg-white rounded-lg shadow-md">
                                            <thead>
                                                <tr className="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                                                    <th className="py-3 px-6 text-left">日期</th>
                                                    <th className="py-3 px-6 text-left">賽事類型</th> {/* New column for event type */}
                                                    <th className="py-3 px-6 text-left">金額</th>
                                                    <th className="py-3 px-6 text-left">賠率</th>
                                                    <th className="py-3 px-6 text-left">結果</th>
                                                    <th className="py-3 px-6 text-left">獲利/虧損</th>
                                                    <th className="py-3 px-6 text-left">操作</th> {/* New column for delete button */}
                                                </tr>
                                            </thead>
                                            <tbody className="text-gray-600 text-sm font-light">
                                                {filteredBetHistory.map((record) => (
                                                    <tr key={record.id} className="border-b border-gray-200 hover:bg-gray-100">
                                                        <td className="py-3 px-6 text-left whitespace-nowrap">{record.date}</td>
                                                        <td className="py-3 px-6 text-left whitespace-nowrap">{record.eventType}</td> {/* Display event type */}
                                                        <td className="py-3 px-6 text-left whitespace-nowrap">{record.betAmount}</td>
                                                        <td className="py-3 px-6 text-left">{record.odds}</td>
                                                        <td className="py-3 px-6 text-left">
                                                            {record.status === 'pending' ? (
                                                                <div className="flex space-x-2">
                                                                    <button
                                                                        onClick={() => updateBetStatus(record.id, 'win')}
                                                                        className="bg-green-500 hover:bg-green-600 text-white text-xs px-2 py-1 rounded-md transition duration-200"
                                                                        disabled={loadingFirebase || !isAuthReady || !userId}
                                                                    >
                                                                        贏
                                                                    </button>
                                                                    <button
                                                                        onClick={() => updateBetStatus(record.id, 'loss')}
                                                                        className="bg-red-500 hover:bg-red-600 text-white text-xs px-2 py-1 rounded-md transition duration-200"
                                                                        disabled={loadingFirebase || !isAuthReady || !userId}
                                                                    >
                                                                        輸
                                                                    </button>
                                                                </div>
                                                            ) : (
                                                                <span className={`px-2 py-1 font-semibold leading-tight rounded-full ${record.outcome === 'win' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                                                    {record.outcome === 'win' ? '贏' : '輸'}
                                                                </span>
                                                            )}
                                                        </td>
                                                        <td className={`py-3 px-6 text-left ${record.status === 'pending' ? 'text-gray-500' : (record.profitLoss >= 0 ? 'text-green-600' : 'text-red-600')}`}>
                                                            {record.status === 'pending' ? '待定' : record.profitLoss.toFixed(2)}
                                                        </td>
                                                        <td className="py-3 px-6 text-left"> {/* Action buttons column */}
                                                            <div className="flex space-x-2">
                                                                <button
                                                                    onClick={() => handleEditRecord(record)}
                                                                    className="bg-blue-500 hover:bg-blue-600 text-white text-xs px-2 py-1 rounded-md transition duration-200"
                                                                    disabled={loadingFirebase || !isAuthReady || !userId}
                                                                >
                                                                    編輯
                                                                </button>
                                                                <button
                                                                    onClick={() => { setShowConfirmDeleteDialog(true); setRecordToDelete(record.id); }}
                                                                    className="bg-gray-400 hover:bg-gray-500 text-white text-xs px-2 py-1 rounded-md transition duration-200"
                                                                    disabled={loadingFirebase || !isAuthReady || !userId}
                                                                >
                                                                    刪除
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div className="mt-4 text-center text-lg font-bold">
                                        篩選後總獲利/虧損:
                                        <span className={`ml-2 ${parseFloat(totalProfitLossFiltered) >= 0 ? 'text-blue-600' : 'text-red-600'}`}>
                                            {totalProfitLossFiltered} NTD
                                        </span>
                                    </div>
                                    {/* Win/Loss Counts and Average Win Rate */}
                                    <div className="mt-2 text-center text-base font-semibold text-gray-700">
                                        總勝場: <span className="text-green-700">{totalWins}</span> |
                                        總敗場: <span className="text-red-700">{totalLosses}</span> |
                                        平均勝率: <span className="text-blue-700">{averageWinRate}%</span>
                                    </div>
                                    {/* Conditional General advice for overall profit/loss */}
                                    <div className="mt-4 text-center text-sm text-gray-600 italic">
                                        {parseFloat(totalProfitLossFiltered) > 0 ? (
                                            generalProfitAdvice[Math.floor(Math.random() * generalProfitAdvice.length)]
                                        ) : parseFloat(totalProfitLossFiltered) < 0 ? (
                                            generalLossAdvice[Math.floor(Math.random() * generalLossAdvice.length)]
                                        ) : (
                                            generalNeutralAdvice[Math.floor(Math.random() * generalNeutralAdvice.length)]
                                        )}
                                    </div>
                                </>
                            ) : (
                                <p className="text-center text-gray-500 mt-8">
                                    沒有符合篩選條件的投注紀錄。
                                </p>
                            )}
                        </div>
                    </div>
                    {/* Copyright notice at the bottom */}
                    <div className="w-full text-center text-gray-600 text-sm mt-8 pb-4">
                        威爾設計版權所有 ver 1.0
                    </div>
                </div>
            );
        }

        // Mount the React app to the root div
        const domContainer = document.querySelector('#root');
        const root = ReactDOM.createRoot(domContainer);
        root.render(<App />);
    </script>
</body>
</html>
