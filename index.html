<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>運彩獲利計算模板 - Ver 1.09</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* CSS for printing only the history section */
        @media print {
            body > *:not(#print-area) { /* Hide all direct children of body except the print area */
                display: none !important;
            }
            #print-area { /* Ensure the print area is visible and takes full width */
                display: block !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            /* Adjust table and text within print area for better print layout */
            #print-area table {
                width: 100%;
                border-collapse: collapse;
            }
            #print-area th, #print-area td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: left;
            }
            #print-area h2 {
                text-align: center;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            signOut,
            getFirestore,
            doc,
            getDoc,
            addDoc,
            setDoc,
            updateDoc,
            deleteDoc,
            onSnapshot,
            collection,
            query,
            where,
            getDocs
        };
    </script>

    <script>
        // ====================================================================================================
        // *** 重要：請務必將以下 Firebase 配置替換為您自己專案的真實數值！ ***
        // 您可以在 Firebase Console -> 專案設定 (齒輪圖示) -> 「您的應用程式」中找到它。
        // 請確保複製的是完整的 JavaScript 物件，例如：{ apiKey: "...", authDomain: "...", ... }
        // 注意：不要在 JSON.stringify() 內部再加額外的引號，例如 JSON.stringify("{ ... }") 是錯誤的。
        // ====================================================================================================
        const __firebase_config = JSON.stringify({
          apiKey: "AIzaSyADSbeZr04Rxr0Al5jKVY1u5j9dnD2Bfx4", // <-- 請替換為您 Firebase 專案的實際 API Key (例如: "AIzaSyB-xxxxxxxxxxxxxxxxxxxxxxxxxxxxx")
          authDomain: "wds-sport.firebaseapp.com", // <-- 請替換為您 Firebase 專案的實際 Auth Domain (例如: "your-project-id.firebaseapp.com")
          projectId: "wds-sport", // <-- 請替換為您 Firebase 專案的實際 Project ID (例如: "your-project-id")
          storageBucket: "wds-sport.firebasestorage.app", // <-- 已替換為您圖片中的實際 Storage Bucket
          messagingSenderId: "765754214969", // <-- 已替換為您圖片中的實際 Sender ID
          appId: "1:765754214969:web:d0b648f04b8526a3019be8", // <-- 沿用之前程式碼中的 App ID
          // measurementId: "YOUR_MEASUREMENT_ID" // 如果有啟用 Google Analytics，請解除註解並替換為您的實際 Measurement ID
        });

        // *** 重要：請自訂一個唯一的應用程式 ID，如果不在 Canvas 環境中運行 ***
        // 這個 ID 必須與您在 Firestore 安全規則中使用的 {appId} 變數完全相符。
        // 例如：如果您在規則中寫 `match /artifacts/my-betting-app-2024/...`，這裡就填 "my-betting-app-2024"。
        // 所有使用相同 __app_id 的用戶將共享同一組資料。
        const __app_id = "your-custom-app-id-here"; // <-- 請替換為您自訂的 ID，例如 "my-betting-app-2024"

        // 這是 Canvas 環境特有的初始認證 Token。
        // 在您本地運行或使用 GitHub Pages 時，此變數通常保持為空字串或移除。
        // 應用程式會自動回退到匿名登入。
        const __initial_auth_token = ""; 
        // ====================================================================================================
        // *** 上述配置替換完畢後，請儲存檔案並重新上傳到您的託管平台！ ***
        // ====================================================================================================
    </script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        // Helper function to get today's date in replete-MM-DD format
        const getTodayDateString = () => {
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const day = today.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        function App() {
            const [db, setDb] = React.useState(null);
            const [auth, setAuth] = React.useState(null);
            const [userId, setUserId] = React.useState(null);
            const [userName, setUserName] = React.useState(null);
            const [userEmail, setUserEmail] = React.useState(null);
            const [isAuthReady, setIsAuthReady] = React.useState(false);
            const [loadingFirebase, setLoadingFirebase] = React.useState(true);

            const [betAmount, setBetAmount] = React.useState('');
            const [odds, setOdds] = React.useState('');
            const [eventType, setEventType] = React.useState('');
            const [playType, setPlayType] = React.useState('');
            const [singleBetResult, setSingleBetResult] = React.useState(null);
            const [errorMessage, setErrorMessage] = React.useState('');
            const [betHistory, setBetHistory] = React.useState([]);

            const [startDate, setStartDate] = React.useState(getTodayDateString());
            const [endDate, setEndDate] = React.useState(getTodayDateString());
            const [selectedEventTypeFilter, setSelectedEventTypeFilter] = React.useState('');
            const [selectedPlayTypeFilter, setSelectedPlayTypeFilter] = React.useState('');

            const [targetProfitAmount, setTargetProfitAmount] = React.useState('');
            const [requiredBetForTargetProfit, setRequiredBetForTargetProfit] = React.useState(null);

            const [showConfirmDeleteDialog, setShowConfirmDeleteDialog] = React.useState(false);
            const [recordToDelete, setRecordToDelete] = React.useState(null);

            const [editingRecordId, setEditingRecordId] = React.useState(null);

            // Version history data
            const versionHistoryData = [
                {
                    version: "1.09",
                    date: "2025-05-27",
                    content: "修正 `ReferenceError: generalNeutralAdvice is not defined` 錯誤，將建議文字陣列移至 App 函數內部。修正 Firestore 集合路徑錯誤。",
                },
                {
                    version: "1.08",
                    date: "2025-05-27",
                    content: "修正 Firestore 集合路徑錯誤 (Invalid collection reference)，確保賽事類型和玩法設定能正確儲存和載入。",
                },
                {
                    version: "1.07",
                    date: "2025-05-27",
                    content: "新增「設定」導覽鍵與彈出視窗。投注頁面新增「玩法」欄位。賽事類型與玩法新增下拉式篩選，並自動統計各類型投注場次。店家退水百分比可設定。",
                },
                {
                    version: "1.06",
                    date: "2025-05-27",
                    content: "調整投注紀錄區的日期和篩選類型大小，優化文字顯示。投注紀錄排序仍為最新在最上方。",
                },
                {
                    version: "1.05",
                    date: "2025-05-27",
                    content: "新增「設定」導覽鍵與彈出視窗。投注頁面新增「玩法」欄位。賽事類型與玩法新增下拉式篩選，並自動統計各類型投注場次。店家退水百分比可設定。",
                },
                {
                    version: "1.04",
                    date: "2025-05-26",
                    content: "投注紀錄頁面預設顯示當日紀錄，可透過日期選擇器查看其他日期。新增「店家退水」統計。",
                },
                {
                    version: "1.03",
                    date: "2025-05-26",
                    content: "「新增紀錄」按鈕現在可以透過按下 Enter 鍵來執行。",
                },
                {
                    version: "1.02",
                    date: "2025-05-26",
                    content: "新增「店家退水」統計。修正列印頁面註解和序號問題。投注紀錄排序改為最新在最上方。",
                },
                {
                    version: "1.01",
                    date: "2025-05-25",
                    content: "新增「更新紀錄」按鈕及彈出視窗，顯示版本更新內容。修正列印頁面註解和序號問題。投注紀錄排序改為最新在最上方。",
                },
                {
                    version: "1.0",
                    date: "2025-05-25",
                    content: "初始版本：包含投注、投注紀錄、Google登入、編輯/刪除、日期篩選、CSV導出、列印、總獲利/總投注金額、勝負場統計、隨機建議。",
                },
            ];

            const [currentVersion, setCurrentVersion] = React.useState(versionHistoryData[0].version);
            const [showUpdateLogModal, setShowUpdateLogModal] = React.useState(false);
            const [showSettingsModal, setShowSettingsModal] = React.useState(false);

            // Shop Rebate Percentage state, loaded from localStorage
            const [shopRebatePercentage, setShopRebatePercentage] = React.useState(() => {
                try {
                    const storedRebate = localStorage.getItem('shopRebatePercentage');
                    return storedRebate ? parseFloat(storedRebate) : 4.0; // Default to 4.0%
                } catch (e) {
                    console.error("Failed to load shopRebatePercentage from localStorage", e);
                    return 4.0;
                }
            });

            // Save shopRebatePercentage to localStorage whenever it changes
            React.useEffect(() => {
                try {
                    localStorage.setItem('shopRebatePercentage', shopRebatePercentage.toString());
                } catch (e) {
                    console.error("Failed to save shopRebatePercentage to localStorage", e);
                }
            }, [shopRebatePercentage]);

            // States for managing unique event types and play types in settings
            const [managedEventTypes, setManagedEventTypes] = React.useState([]);
            const [managedPlayTypes, setManagedPlayTypes] = React.useState([]);
            const [newEventTypeInput, setNewEventTypeInput] = React.useState('');
            const [newPlayTypeInput, setNewPlayTypeInput] = React.useState('');

            // --- Firebase Initialization and Authentication ---
            React.useEffect(() => {
                const initializeFirebase = async () => {
                    try {
                        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                        const app = window.firebase.initializeApp(firebaseConfig);
                        const authInstance = window.firebase.getAuth(app);
                        const dbInstance = window.firebase.getFirestore(app);

                        setAuth(authInstance);
                        setDb(dbInstance);

                        const unsubscribe = window.firebase.onAuthStateChanged(authInstance, async (user) => {
                            if (user) {
                                setUserId(user.uid);
                                setUserName(user.displayName || user.email || '匿名用戶');
                                setUserEmail(user.email);
                            } else {
                                try {
                                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token !== '') {
                                        await window.firebase.signInWithCustomToken(authInstance, __initial_auth_token);
                                    } else {
                                        await window.firebase.signInAnonymously(authInstance);
                                    }
                                } catch (anonError) {
                                    console.error("Anonymous sign-in failed:", anonError);
                                    setErrorMessage("匿名登入失敗，請檢查 Firebase 認證設定或 API 金鑰。");
                                }
                            }
                            setIsAuthReady(true);
                            setLoadingFirebase(false);
                        });

                        return () => unsubscribe();
                    } catch (error) {
                        console.error("Firebase initialization failed:", error);
                        setErrorMessage("Firebase 初始化失敗，請檢查設定。");
                        setLoadingFirebase(false);
                    }
                };

                initializeFirebase();
            }, []);

            // --- Load managed event types and play types from Firestore ---
            React.useEffect(() => {
                if (!db || !isAuthReady || !userId) return;

                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                // Corrected path: added 'userSettings' document to make segments odd
                const eventTypesRef = window.firebase.collection(db, `artifacts/${appId}/users/${userId}/settings/userSettings/eventTypes`);
                const playTypesRef = window.firebase.collection(db, `artifacts/${appId}/users/${userId}/settings/userSettings/playTypes`);

                const unsubscribeEventTypes = window.firebase.onSnapshot(eventTypesRef, (snapshot) => {
                    const types = snapshot.docs.map(doc => doc.id); // Use doc.id as the type name
                    setManagedEventTypes(types.sort());
                }, (error) => {
                    console.error("Error fetching event types:", error);
                });

                const unsubscribePlayTypes = window.firebase.onSnapshot(playTypesRef, (snapshot) => {
                    const types = snapshot.docs.map(doc => doc.id); // Use doc.id as the type name
                    setManagedPlayTypes(types.sort());
                }, (error) => {
                    console.error("Error fetching play types:", error);
                });

                return () => {
                    unsubscribeEventTypes();
                    unsubscribePlayTypes();
                };
            }, [db, isAuthReady, userId]);


            const handleGoogleSignIn = async () => {
                setErrorMessage('');
                if (!auth) {
                    setErrorMessage("認證服務未準備好。");
                    return;
                }
                try {
                    const provider = new window.firebase.GoogleAuthProvider();
                    await window.firebase.signInWithPopup(auth, provider);
                } catch (error) {
                    console.error("Google Sign-In failed:", error);
                    let msg = "Google 登入失敗。";
                    if (error.code === 'auth/popup-closed-by-user') {
                        msg = "Google 登入視窗已關閉。";
                    } else if (error.code === 'auth/cancelled-popup-request') {
                        msg = "已取消先前的登入請求。";
                    } else if (error.code === 'auth/unauthorized-domain') {
                        msg = "未授權的網域。請在 Firebase Console 中新增您的網域。";
                    }
                    setErrorMessage(msg + " 請檢查 Firebase 認證設定。");
                }
            };

            const handleSignOut = async () => {
                setErrorMessage('');
                if (!auth) {
                    setErrorMessage("認證服務未準備好。");
                    return;
                }
                try {
                    await window.firebase.signOut(auth);
                    setUserId(null);
                    setUserName(null);
                    setUserEmail(null);
                    setBetHistory([]);
                } catch (error) {
                    console.error("Sign Out failed:", error);
                    setErrorMessage("登出失敗。");
                }
            };

            React.useEffect(() => {
                if (!db || !isAuthReady || !userId) {
                    if (betHistory.length > 0) {
                        setBetHistory([]);
                    }
                    return;
                }

                let unsubscribe;
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const bettingHistoryCollectionRef = window.firebase.collection(db, `artifacts/${appId}/users/${userId}/bettingHistory`);

                    unsubscribe = window.firebase.onSnapshot(bettingHistoryCollectionRef, (snapshot) => {
                        const records = [];
                        snapshot.forEach(doc => {
                            records.push({ id: doc.id, ...doc.data() });
                        });
                        records.sort((a, b) => {
                            const timeA = a.timestamp ? (a.timestamp.toDate ? a.timestamp.toDate().getTime() : a.timestamp) : a.id;
                            const timeB = b.timestamp ? (b.timestamp.toDate ? b.timestamp.toDate().getTime() : b.timestamp) : b.id;
                            return timeA - timeB;
                        });
                        setBetHistory(records);
                    }, (error) => {
                        console.error("Error fetching real-time data:", error);
                        setErrorMessage("無法載入即時投注紀錄。");
                    });

                } catch (error) {
                    console.error("Failed to set up Firestore listener:", error);
                    setErrorMessage("設定資料庫監聽失敗。");
                }

                return () => {
                    if (unsubscribe) unsubscribe();
                };
            }, [db, isAuthReady, userId]);

            const calculateInstantResults = React.useCallback(() => {
                const parsedBetAmount = parseFloat(betAmount);
                const parsedOdds = parseFloat(odds);
                const parsedTargetProfitAmount = parseFloat(targetProfitAmount);

                if (isNaN(parsedBetAmount) || parsedBetAmount <= 0 || isNaN(parsedOdds) || parsedOdds < 1) {
                    setSingleBetResult(null);
                } else {
                    const potentialProfitIfWon = (parsedBetAmount * parsedOdds) - parsedBetAmount;
                    setSingleBetResult(potentialProfitIfWon.toFixed(2));
                }

                if (isNaN(parsedTargetProfitAmount) || parsedTargetProfitAmount <= 0 || isNaN(parsedOdds) || parsedOdds < 1 || (parsedOdds - 1) <= 0) {
                    setRequiredBetForTargetProfit(null);
                } else {
                    const requiredBet = parsedTargetProfitAmount / (parsedOdds - 1);
                    setRequiredBetForTargetProfit(requiredBet.toFixed(2));
                }

            }, [betAmount, odds, targetProfitAmount]);

            React.useEffect(() => {
                calculateInstantResults();
            }, [betAmount, odds, targetProfitAmount, calculateInstantResults]);

            const handleSaveRecordButtonClick = async () => {
                setErrorMessage('');
                if (!db || !userId) {
                    setErrorMessage("資料庫未準備好或未登入。請先登入。");
                    return;
                }

                const parsedBetAmount = parseFloat(betAmount);
                const parsedOdds = parseFloat(odds);

                if (isNaN(parsedBetAmount) || parsedBetAmount <= 0) {
                    setErrorMessage('請輸入有效的投注金額 (必須是正數)。');
                    return;
                }
                if (isNaN(parsedOdds) || parsedOdds < 1) {
                    setErrorMessage('請輸入有效的賠率 (必須大於或等於 1)。');
                    return;
                }
                if (eventType.trim() === '') {
                    setErrorMessage('請選擇或輸入賽事類型。');
                    return;
                }
                if (playType.trim() === '') {
                    setErrorMessage('請選擇或輸入玩法。');
                    return;
                }

                const now = new Date();
                const localDateTimeString = now.toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                }).replace(/\//g, '-');

                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const collectionRef = window.firebase.collection(db, `artifacts/${appId}/users/${userId}/bettingHistory`);

                    if (editingRecordId) {
                        const docRef = window.firebase.doc(collectionRef, editingRecordId);
                        await window.firebase.updateDoc(docRef, {
                            betAmount: parsedBetAmount,
                            odds: parsedOdds,
                            eventType: eventType.trim(),
                            playType: playType.trim(),
                        });
                        setErrorMessage("紀錄已成功更新。");
                        setEditingRecordId(null);
                    } else {
                        await window.firebase.addDoc(collectionRef, {
                            betAmount: parsedBetAmount,
                            odds: parsedOdds,
                            eventType: eventType.trim(),
                            playType: playType.trim(),
                            outcome: null,
                            profitLoss: 0,
                            date: localDateTimeString,
                            status: 'pending',
                            timestamp: window.firebase.serverTimestamp ? window.firebase.serverTimestamp() : Date.now(),
                            addedBy: userId,
                        });
                        setErrorMessage("新增紀錄成功。");
                    }

                    // Also add new eventType/playType to managed lists if they don't exist
                    const eventTypesSettingsRef = window.firebase.collection(db, `artifacts/${appId}/users/${userId}/settings/userSettings/eventTypes`);
                    const playTypesSettingsRef = window.firebase.collection(db, `artifacts/${appId}/users/${userId}/settings/userSettings/playTypes`);

                    if (eventType.trim() && !managedEventTypes.includes(eventType.trim())) {
                        await window.firebase.setDoc(window.firebase.doc(eventTypesSettingsRef, eventType.trim()), { exists: true });
                    }
                    if (playType.trim() && !managedPlayTypes.includes(playType.trim())) {
                        await window.firebase.setDoc(window.firebase.doc(playTypesSettingsRef, playType.trim()), { exists: true });
                    }

                    setEventType('');
                    setPlayType('');
                }
                catch (error) {
                    console.error("Error saving document:", error);
                    setErrorMessage("儲存紀錄失敗。");
                }
            };

            const updateBetStatus = async (id, finalOutcome) => {
                setErrorMessage('');
                if (!db || !userId) {
                    setErrorMessage("資料庫未準備好或未登入。");
                    return;
                }
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const docRef = window.firebase.doc(db, `artifacts/${appId}/users/${userId}/bettingHistory`, id);
                    const docSnap = await window.firebase.getDoc(docRef);

                    if (docSnap.exists()) {
                        const recordData = docSnap.data();
                        let updatedProfitLoss = 0;
                        if (finalOutcome === 'win') {
                            updatedProfitLoss = (recordData.betAmount * recordData.odds) - recordData.betAmount;
                        } else if (finalOutcome === 'loss') {
                            updatedProfitLoss = -recordData.betAmount;
                        }

                        await window.firebase.updateDoc(docRef, {
                            outcome: finalOutcome,
                            profitLoss: updatedProfitLoss,
                            status: finalOutcome,
                            settledBy: userId,
                            settledAt: window.firebase.serverTimestamp ? window.firebase.serverTimestamp() : Date.now(),
                        });
                    } else {
                        setErrorMessage("找不到該紀錄。");
                    }
                } catch (error) {
                    console.error("Error updating document:", error);
                    setErrorMessage("更新紀錄失敗。");
                }
            };

            const handleEditRecord = (record) => {
                setBetAmount(record.betAmount.toString());
                setOdds(record.odds.toString());
                setEventType(record.eventType);
                setPlayType(record.playType || '');
                setEditingRecordId(record.id);
                setErrorMessage('');
                setSingleBetResult(null);
                setTargetProfitAmount('');
                setRequiredBetForTargetProfit(null);
            };

            const handleCancelEdit = () => {
                setEditingRecordId(null);
                setBetAmount('');
                setOdds('');
                setEventType('');
                setPlayType('');
                setErrorMessage('');
                setSingleBetResult(null);
                setTargetProfitAmount('');
                setRequiredBetForTargetProfit(null);
            };

            const handleDeleteRecord = async () => {
                setErrorMessage('');
                if (!db || !userId || !recordToDelete) {
                    setErrorMessage("無法刪除紀錄，資料庫未準備好或未登入。");
                    setShowConfirmDeleteDialog(false);
                    setRecordToDelete(null);
                    return;
                }

                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const docRef = window.firebase.doc(db, `artifacts/${appId}/users/${userId}/bettingHistory`, recordToDelete);
                    await window.firebase.deleteDoc(docRef);
                    
                    setErrorMessage("紀錄已成功刪除。");
                    setShowConfirmDeleteDialog(false);
                    setRecordToDelete(null);
                } catch (error) {
                    console.error("Error deleting document:", error);
                    setErrorMessage("刪除紀錄失敗。");
                    setShowConfirmDeleteDialog(false);
                    setRecordToDelete(null);
                }
            };

            // Functions to manage event types in settings
            const handleAddManagedEventType = async () => {
                if (newEventTypeInput.trim() === '') {
                    setErrorMessage("請輸入有效的賽事類型名稱。");
                    return;
                }
                if (managedEventTypes.includes(newEventTypeInput.trim())) {
                    setErrorMessage("此賽事類型已存在。");
                    return;
                }
                setErrorMessage('');
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const eventTypesRef = window.firebase.collection(db, `artifacts/${appId}/users/${userId}/settings/userSettings/eventTypes`);
                    await window.firebase.setDoc(window.firebase.doc(eventTypesRef, newEventTypeInput.trim()), { exists: true });
                    setNewEventTypeInput('');
                } catch (error) {
                    console.error("Error adding event type:", error);
                    setErrorMessage("新增賽事類型失敗。");
                }
            };

            const handleDeleteManagedEventType = async (typeToDelete) => {
                setErrorMessage('');
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const eventTypesRef = window.firebase.collection(db, `artifacts/${appId}/users/${userId}/settings/userSettings/eventTypes`);
                    await window.firebase.deleteDoc(window.firebase.doc(eventTypesRef, typeToDelete));
                } catch (error) {
                    console.error("Error deleting event type:", error);
                    setErrorMessage("刪除賽事類型失敗。");
                }
            };

            // Functions to manage play types in settings
            const handleAddManagedPlayType = async () => {
                if (newPlayTypeInput.trim() === '') {
                    setErrorMessage("請輸入有效的玩法名稱。");
                    return;
                }
                if (managedPlayTypes.includes(newPlayTypeInput.trim())) {
                    setErrorMessage("此玩法已存在。");
                    return;
                }
                setErrorMessage('');
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const playTypesRef = window.firebase.collection(db, `artifacts/${appId}/users/${userId}/settings/userSettings/playTypes`);
                    await window.firebase.setDoc(window.firebase.doc(playTypesRef, newPlayTypeInput.trim()), { exists: true });
                    setNewPlayTypeInput('');
                } catch (error) {
                    console.error("Error adding play type:", error);
                    setErrorMessage("新增玩法失敗。");
                }
            };

            const handleDeleteManagedPlayType = async (typeToDelete) => {
                setErrorMessage('');
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const playTypesRef = window.firebase.collection(db, `artifacts/${appId}/users/${userId}/settings/userSettings/playTypes`);
                    await window.firebase.deleteDoc(window.firebase.doc(playTypesRef, typeToDelete));
                } catch (error) {
                    console.error("Error deleting play type:", error);
                    setErrorMessage("刪除玩法失敗。");
                }
            };


            const filteredBetHistory = React.useMemo(() => {
                const filtered = betHistory.filter(record => {
                    const recordDate = new Date(record.date.replace(/-/g, '/'));
                    const start = startDate ? new Date(startDate) : null;
                    const end = endDate ? new Date(endDate) : null;

                    if (end) {
                        end.setHours(23, 59, 59, 999);
                    }

                    const recordDateOnly = new Date(record.date.substring(0, 10));
                    const startDateOnly = startDate ? new Date(startDate) : null;
                    const endDateOnly = endDate ? new Date(endDate) : null;

                    const isAfterStartDate = !startDateOnly || recordDateOnly >= startDateOnly;
                    const isBeforeEndDate = !endDateOnly || recordDateOnly <= endDateOnly;

                    const isMatchingEventType = !selectedEventTypeFilter || record.eventType === selectedEventTypeFilter;
                    const isMatchingPlayType = !selectedPlayTypeFilter || record.playType === selectedPlayTypeFilter;


                    return isAfterStartDate && isBeforeEndDate && isMatchingEventType && isMatchingPlayType;
                });
                // Sort by date in descending order (newest first)
                return filtered.sort((a, b) => {
                    const dateA = new Date(a.date.replace(/-/g, '/')).getTime();
                    const dateB = new Date(b.date.replace(/-/g, '/')).getTime();
                    return dateB - dateA;
                });
            }, [betHistory, startDate, endDate, selectedEventTypeFilter, selectedPlayTypeFilter]);

            const totalProfitLossFiltered = filteredBetHistory.reduce((sum, record) => {
                if (record.status === 'win' || record.status === 'loss') {
                    return sum + record.profitLoss;
                }
                return sum;
            }, 0).toFixed(2);

            const totalBetAmountFiltered = filteredBetHistory.reduce((sum, record) => {
                return sum + record.betAmount;
            }, 0).toFixed(2);

            const shopRebateAmount = (parseFloat(totalBetAmountFiltered) * (shopRebatePercentage / 100)).toFixed(2);


            const { totalWins, totalLosses, averageWinRate } = React.useMemo(() => {
                let wins = 0;
                let losses = 0;
                filteredBetHistory.forEach(record => {
                    if (record.status === 'win') {
                        wins++;
                    } else if (record.status === 'loss') {
                        losses++;
                    }
                });
                const totalSettledBets = wins + losses;
                const avgWinRate = totalSettledBets > 0 ? ((wins / totalSettledBets) * 100).toFixed(2) : '0.00';
                return { totalWins: wins, totalLosses: losses, averageWinRate: avgWinRate };
            }, [filteredBetHistory]);

            // Calculate event type counts for display
            const eventTypeCounts = React.useMemo(() => {
                const counts = {};
                filteredBetHistory.forEach(record => {
                    counts[record.eventType] = (counts[record.eventType] || 0) + 1;
                });
                return counts;
            }, [filteredBetHistory]);

            // Calculate play type counts for display
            const playTypeCounts = React.useMemo(() => {
                const counts = {};
                filteredBetHistory.forEach(record => {
                    if (record.playType) {
                        counts[record.playType] = (counts[record.playType] || 0) + 1;
                    }
                });
                return counts;
            }, [filteredBetHistory]);


            const resetFields = () => {
                setBetAmount('');
                setOdds('');
                setEventType('');
                setPlayType('');
                setSingleBetResult(null);
                setErrorMessage('');
                setStartDate(getTodayDateString());
                setEndDate(getTodayDateString());
                setSelectedEventTypeFilter('');
                setSelectedPlayTypeFilter('');
                setTargetProfitAmount('');
                setRequiredBetForTargetProfit(null);
                setEditingRecordId(null);
            };

            const exportToCsv = () => {
                if (filteredBetHistory.length === 0) {
                    setErrorMessage('沒有紀錄可以導出。');
                    return;
                }

                const headers = ["序號", "日期時間", "賽事類型", "玩法", "投注金額", "賠率", "結果", "獲利/虧損"];
                const csvRows = [];

                csvRows.push(headers.join(','));

                filteredBetHistory.forEach((record, index) => {
                    const row = [
                        index + 1,
                        record.date,
                        record.eventType,
                        record.playType || '',
                        record.betAmount,
                        record.odds,
                        record.status === 'pending' ? '待定' : (record.outcome === 'win' ? '贏' : '輸'),
                        record.status === 'pending' ? '待定' : record.profitLoss.toFixed(2)
                    ];
                    csvRows.push(row.join(','));
                });

                csvRows.push('');
                csvRows.push(`篩選後總獲利/虧損:,${totalProfitLossFiltered} NTD`);
                csvRows.push(`當日總投注金額:,${totalBetAmountFiltered} NTD`);
                csvRows.push(`店家退水:,${shopRebateAmount} NTD`);
                csvRows.push(`總勝場:,${totalWins}`);
                csvRows.push(`總敗場:,${totalLosses}`);
                csvRows.push(`平均勝率:,${averageWinRate}%`);
                csvRows.push('');
                Object.entries(eventTypeCounts).forEach(([type, count]) => {
                    csvRows.push(`${type} 投注場次:,${count}`);
                });
                Object.entries(playTypeCounts).forEach(([type, count]) => {
                    csvRows.push(`${type} 玩法場次:,${count}`);
                });


                const csvString = csvRows.join('\n');
                const blob = new Blob(['\ufeff' + csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `運彩紀錄_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
            };

            const handlePrintRecordsOnly = () => {
                const printContent = document.getElementById('bet-history-section');
                if (!printContent) {
                    setErrorMessage('找不到投注紀錄區塊進行列印。');
                    return;
                }

                // Construct the HTML content for the new print window
                let printContentHtml = `
                    <!DOCTYPE html>
                    <html lang="zh-TW">
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>投注紀錄列印</title>
                        <style>
                            body { font-family: 'Inter', sans-serif; margin: 20px; }
                            h2 { text-align: center; margin-bottom: 20px; font-size: 1.5em; }
                            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background-color: #f2f2f2; }
                            .profit-text { color: #16A34A; font-weight: bold; }
                            .loss-text { color: #DC2626; font-weight: bold; }
                            .blue-text { color: #2563EB; font-weight: bold; }
                            .red-text { color: #DC2626; font-weight: bold; }
                            .outcome-badge {
                                display: inline-block;
                                padding: 4px 8px;
                                border-radius: 9999px;
                                font-weight: 600;
                                font-size: 0.8em;
                                line-height: 1;
                            }
                            .win-badge { background-color: #D1FAE5; color: #065F46; }
                            .loss-badge { background-color: #FEE2E2; color: #991B1B; }
                        </style>
                        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
                    </head>
                    <body>
                        <h2>投注紀錄</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>序號</th>
                                    <th>日期時間</th>
                                    <th>賽事類型</th>
                                    <th>玩法</th>
                                    <th>金額</th>
                                    <th>賠率</th>
                                    <th>結果</th>
                                    <th>獲利/虧損</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredBetHistory.map((record, index) => `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td>${record.date}</td>
                                        <td>${record.eventType}</td>
                                        <td>${record.playType || ''}</td>
                                        <td>${record.betAmount}</td>
                                        <td>${record.odds}</td>
                                        <td>
                                            <span class="outcome-badge ${record.status === 'win' ? 'win-badge' : (record.status === 'loss' ? 'loss-badge' : '')}">
                                                ${record.status === 'pending' ? '待定' : (record.outcome === 'win' ? '贏' : '輸')}
                                            </span>
                                        </td>
                                        <td class="${record.status === 'win' ? 'profit-text' : (record.status === 'loss' ? 'loss-text' : '')}">
                                            ${record.status === 'pending' ? '待定' : record.profitLoss.toFixed(2)}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div style="text-align: center; margin-top: 20px; font-size: 1.1em; font-weight: bold;">
                            篩選後總獲利/虧損:
                            <span class="${parseFloat(totalProfitLossFiltered) >= 0 ? 'blue-text' : 'red-text'}">
                                ${totalProfitLossFiltered} NTD
                            </span>
                        </div>
                        <div style="text-align: center; margin-top: 10px; font-size: 1em;">
                            當日總投注金額: ${totalBetAmountFiltered} NTD
                        </div>
                        <div style="text-align: center; margin-top: 10px; font-size: 1em;">
                            店家退水: ${shopRebateAmount} NTD
                        </div>
                        <div style="text-align: center; margin-top: 10px; font-size: 1em;">
                            總勝場: ${totalWins} | 總敗場: ${totalLosses} | 平均勝率: ${averageWinRate}%
                        </div>
                        ${Object.keys(eventTypeCounts).length > 0 ? `
                            <div style="text-align: center; margin-top: 10px; font-size: 1em;">
                                ${Object.entries(eventTypeCounts).map(([type, count]) => `${type}: ${count} 場`).join(' | ')}
                            </div>
                        ` : ''}
                        ${Object.keys(playTypeCounts).length > 0 ? `
                            <div style="text-align: center; margin-top: 10px; font-size: 1em;">
                                ${Object.entries(playTypeCounts).map(([type, count]) => `${type} 玩法: ${count} 場`).join(' | ')}
                            </div>
                        ` : ''}
                        <div style="text-align: center; margin-top: 30px; font-size: 0.8em; color: #6B7280;">
                            威爾設計版權所有 ver ${currentVersion}
                        </div>
                    </body>
                    </html>
                `;

                const printWindow = window.open('', '_blank', 'width=800,height=600');
                if (printWindow) {
                    printWindow.document.write(printContentHtml);
                    printWindow.document.close();
                    printWindow.focus();

                    printWindow.onload = () => {
                        printWindow.print();
                        printWindow.close();
                    };
                } else {
                    setErrorMessage('無法開啟列印視窗，請檢查瀏覽器設定或彈出視窗阻擋。');
                }
            };


            return (
                <div className="min-h-screen bg-gradient-to-br from-red-100 to-white flex flex-col items-center justify-center p-4 font-sans">
                    {/* Display loading state */}
                    {loadingFirebase && (
                        <div className="absolute inset-0 bg-gray-200 bg-opacity-75 flex items-center justify-center z-50">
                            <div className="text-gray-800 text-lg font-bold">載入中...</div>
                        </div>
                    )}

                    {/* User Info and Sign-in/Sign-out buttons */}
                    <div className="absolute top-4 left-4 right-4 flex flex-col sm:flex-row justify-between items-start sm:items-center bg-gray-100 text-gray-700 text-xs px-3 py-2 rounded-full shadow-md z-10">
                        {userId ? (
                            <div className="flex items-center">
                                <span className="font-bold mr-1">登入用戶:</span>
                                {userName || userEmail || userId}
                                {userEmail && <span className="ml-2 text-gray-500">({userEmail})</span>}
                            </div>
                        ) : (
                            <span className="font-bold">未登入</span>
                        )}
                        <div className="mt-2 sm:mt-0 flex space-x-2">
                            {userId && !userEmail ? (
                                <button
                                    onClick={handleGoogleSignIn}
                                    className="bg-blue-500 hover:bg-blue-600 text-white text-xs px-3 py-1 rounded-full transition duration-200"
                                    disabled={loadingFirebase || !isAuthReady}
                                >
                                    Google 登入
                                </button>
                            ) : userId && userEmail ? (
                                <button
                                    onClick={handleSignOut}
                                    className="bg-red-500 hover:bg-red-600 text-white text-xs px-3 py-1 rounded-full transition duration-200"
                                    disabled={loadingFirebase || !isAuthReady}
                                >
                                    登出
                                </button>
                            ) : (
                                <button
                                    onClick={handleGoogleSignIn}
                                    className="bg-blue-500 hover:bg-blue-600 text-white text-xs px-3 py-1 rounded-full transition duration-200"
                                    disabled={loadingFirebase || !isAuthReady}
                                >
                                    Google 登入
                                </button>
                            )}
                        </div>
                        {/* Settings Button */}
                        <button
                            onClick={() => setShowSettingsModal(true)}
                            className="absolute top-2 right-4 p-2 rounded-full bg-gray-200 hover:bg-gray-300 text-gray-700 transition duration-200 focus:outline-none focus:ring-2 focus:ring-gray-400"
                            title="設定"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fillRule="evenodd" d="M11.49 3.17c-.38-1.16-1.47-1.16-1.85 0L9 4.38a1 1 0 01-.78.78l-1.16.38c-1.16.38-1.16 1.47 0 1.85l.38.78a1 1 0 01.78.78l.38 1.16c.38 1.16 1.47 1.16 1.85 0l.78-.38a1 1 0 01.78-.78l1.16-.38c1.16-.38 1.16-1.47 0-1.85l-.38-.78a1 1 0 01-.78-.78l-.38-1.16zM15.5 13a3.5 3.5 0 11-7 0 3.5 3.5 0 017 0zM17.5 12a.5.5 0 00-.5.5v2a.5.5 0 00.5.5h2a.5.5 0 00.5-.5v-2a.5.5 0 00-.5-.5h-2z" clipRule="evenodd" />
                            </svg>
                        </button>
                    </div>


                    {/* Confirmation Dialog for single record delete */}
                    {showConfirmDeleteDialog && recordToDelete && (
                        <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-lg shadow-xl text-center">
                                <p className="text-lg font-semibold mb-4">確定要刪除這筆紀錄嗎？</p>
                                <p className="text-sm text-gray-600 mb-6">此操作無法復原。</p>
                                <div className="flex justify-center space-x-4">
                                    <button
                                        onClick={() => { setShowConfirmDeleteDialog(false); setRecordToDelete(null); }}
                                        className="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-200"
                                    >
                                        取消
                                    </button>
                                    <button
                                        onClick={handleDeleteRecord}
                                        className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200"
                                    >
                                        確認刪除
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Settings Modal */}
                    {showSettingsModal && (
                        <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4">
                            <div className="bg-white p-6 rounded-lg shadow-xl max-w-md w-full">
                                <h2 className="text-2xl font-bold text-gray-900 mb-4 text-center">設定</h2>
                                <div className="mb-4">
                                    <label htmlFor="shopRebate" className="block text-gray-700 text-sm font-semibold mb-2">
                                        店家退水百分比 (%):
                                    </label>
                                    <input
                                        type="number"
                                        id="shopRebate"
                                        value={shopRebatePercentage}
                                        onChange={(e) => setShopRebatePercentage(parseFloat(e.target.value) || 0)}
                                        placeholder="例如: 4.0"
                                        step="0.1"
                                        min="0"
                                        max="100"
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                    />
                                    <p className="text-xs text-gray-500 mt-1">
                                        用於計算店家退水金額 (總投注金額 x 百分比 / 100)。
                                    </p>
                                </div>
                                {/* New: Event Type Management */}
                                <div className="mb-4 border-t pt-4 mt-4">
                                    <h3 className="text-lg font-semibold text-gray-800 mb-2">管理賽事類型</h3>
                                    <div className="flex flex-wrap gap-2 mb-2">
                                        {managedEventTypes.map(type => (
                                            <span key={type} className="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-sm flex items-center">
                                                {type}
                                                <button
                                                    onClick={() => handleDeleteManagedEventType(type)}
                                                    className="ml-1 text-blue-600 hover:text-blue-800 focus:outline-none"
                                                >
                                                    &times;
                                                </button>
                                            </span>
                                        ))}
                                    </div>
                                    <div className="flex">
                                        <input
                                            type="text"
                                            placeholder="新增賽事類型"
                                            value={newEventTypeInput}
                                            onChange={(e) => setNewEventTypeInput(e.target.value)}
                                            onKeyDown={(e) => {
                                                if (e.key === 'Enter') {
                                                    handleAddManagedEventType();
                                                }
                                            }}
                                            className="flex-grow px-4 py-2 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                        />
                                        <button
                                            onClick={handleAddManagedEventType}
                                            className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-r-lg transition duration-200"
                                        >
                                            新增
                                        </button>
                                    </div>
                                </div>
                                {/* New: Play Type Management */}
                                <div className="mb-4 border-t pt-4 mt-4">
                                    <h3 className="text-lg font-semibold text-gray-800 mb-2">管理玩法</h3>
                                    <div className="flex flex-wrap gap-2 mb-2">
                                        {managedPlayTypes.map(type => (
                                            <span key={type} className="bg-green-100 text-green-800 px-2 py-1 rounded-full text-sm flex items-center">
                                                {type}
                                                <button
                                                    onClick={() => handleDeleteManagedPlayType(type)}
                                                    className="ml-1 text-green-600 hover:text-green-800 focus:outline-none"
                                                >
                                                    &times;
                                                </button>
                                            </span>
                                        ))}
                                    </div>
                                    <div className="flex">
                                        <input
                                            type="text"
                                            placeholder="新增玩法"
                                            value={newPlayTypeInput}
                                            onChange={(e) => setNewPlayTypeInput(e.target.value)}
                                            onKeyDown={(e) => {
                                                if (e.key === 'Enter') {
                                                    handleAddManagedPlayType();
                                                }
                                            }}
                                            className="flex-grow px-4 py-2 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                        />
                                        <button
                                            onClick={handleAddManagedPlayType}
                                            className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-r-lg transition duration-200"
                                        >
                                            新增
                                        </button>
                                    </div>
                                </div>
                                <div className="text-center mt-4">
                                    <button
                                        onClick={() => setShowSettingsModal(false)} // Simply close on "確定更新"
                                        className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200"
                                    >
                                        確定更新
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}


                    {/* Main container for calculator and history, using flexbox for side-by-side layout */}
                    <div className="flex flex-col md:flex-row md:space-x-8 w-full max-w-7xl mt-20 sm:mt-24">
                        {/* Calculator section (left side) */}
                        <div className="bg-white p-8 rounded-xl shadow-2xl w-full md:w-2/5 mb-8 md:mb-0 transform transition-all duration-300 hover:scale-[1.01]">
                            <h1 className="text-3xl font-extrabold text-gray-900 mb-6 text-center">
                                投注
                            </h1>

                            {/* Input field for Bet Amount */}
                            <div className="mb-4">
                                <label htmlFor="betAmount" className="block text-gray-700 text-sm font-semibold mb-2">
                                    投注金額 (NTD):
                                </label>
                                <input
                                    type="number"
                                    id="betAmount"
                                    value={betAmount}
                                    onChange={(e) => setBetAmount(e.target.value)}
                                    placeholder="例如: 1000"
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                    onKeyDown={(e) => { if (e.key === 'Enter') handleSaveRecordButtonClick(); }}
                                />
                            </div>

                            {/* Input field for Odds */}
                            <div className="mb-4">
                                <label htmlFor="odds" className="block text-gray-700 text-sm font-semibold mb-2">
                                    賠率:
                                </label>
                                <input
                                    type="number"
                                    id="odds"
                                    value={odds}
                                    onChange={(e) => setOdds(e.target.value)}
                                    placeholder="請先輸入賠率"
                                    step="0.01"
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                    onKeyDown={(e) => { if (e.key === 'Enter') handleSaveRecordButtonClick(); }}
                                />
                            </div>

                            {/* Event Type Dropdown/Input */}
                            <div className="mb-4">
                                <label htmlFor="eventType" className="block text-gray-700 text-sm font-semibold mb-2">
                                    賽事類型:
                                </label>
                                <select
                                    id="eventType"
                                    value={eventType}
                                    onChange={(e) => setEventType(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                >
                                    <option value="">請選擇</option>
                                    {managedEventTypes.map(type => (
                                        <option key={type} value={type}>{type}</option>
                                    ))}
                                </select>
                                {/* Allow typing new event type if not in dropdown (or if empty string selected) */}
                                {(!eventType || !managedEventTypes.includes(eventType)) && (
                                    <input
                                        type="text"
                                        value={eventType}
                                        onChange={(e) => setEventType(e.target.value)}
                                        placeholder="輸入新賽事類型"
                                        className="w-full px-4 py-2 mt-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                        onKeyDown={(e) => { if (e.key === 'Enter') handleSaveRecordButtonClick(); }}
                                    />
                                )}
                            </div>

                            {/* Play Type Dropdown/Input */}
                            <div className="mb-4">
                                <label htmlFor="playType" className="block text-gray-700 text-sm font-semibold mb-2">
                                    玩法:
                                </label>
                                <select
                                    id="playType"
                                    value={playType}
                                    onChange={(e) => setPlayType(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                >
                                    <option value="">請選擇</option>
                                    {managedPlayTypes.map(type => (
                                        <option key={type} value={type}>{type}</option>
                                    ))}
                                </select>
                                {(!playType || !managedPlayTypes.includes(playType)) && (
                                    <input
                                        type="text"
                                        value={playType}
                                        onChange={(e) => setPlayType(e.target.value)}
                                        placeholder="輸入新玩法"
                                        className="w-full px-4 py-2 mt-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                        onKeyDown={(e) => { if (e.key === 'Enter') handleSaveRecordButtonClick(); }}
                                    />
                                )}
                            </div>

                            {/* Error message display */}
                            {errorMessage && (
                                <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4" role="alert">
                                    <span className="block sm:inline">{errorMessage}</span>
                                </div>
                            )}

                            {/* Calculation and Save/Reset/Cancel buttons */}
                            <div className="flex space-x-4 mb-6">
                                <button
                                    onClick={handleSaveRecordButtonClick}
                                    className="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75"
                                    disabled={loadingFirebase || !isAuthReady}
                                >
                                    {editingRecordId ? '更新紀錄' : '新增紀錄'}
                                </button>
                                <button
                                    onClick={resetFields}
                                    className="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75"
                                >
                                    重設
                                </button>
                                {editingRecordId && (
                                    <button
                                        onClick={handleCancelEdit}
                                        className="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75 ml-2"
                                    >
                                        取消編輯
                                    </button>
                                )}
                            </div>

                            {/* Display area for the single bet result */}
                            {singleBetResult !== null && (
                                <div className="mt-6 p-6 bg-gray-50 rounded-xl shadow-inner text-center mb-4">
                                    <h2 className="text-xl font-semibold text-gray-700 mb-2">單次投注預覽 (潛在獲利):</h2>
                                    <p className={`text-4xl font-extrabold ${parseFloat(singleBetResult) >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                        {parseFloat(singleBetResult) >= 0 ? '獲利' : '虧損'}: {singleBetResult} NTD
                                    </p>
                                    {parseFloat(singleBetResult) > 0 && (
                                        <p className="text-sm text-gray-600 mt-2">此為若成功，預期之淨獲利。</p>
                                    )}
                                    {parseFloat(singleBetResult) === 0 && (
                                        <p className="text-sm text-gray-600 mt-2">此為若成功，預期收支平衡。</p>
                                    )}
                                    {parseFloat(singleBetResult) < 0 && (
                                        <>
                                            <p className="text-sm text-gray-600 mt-2">此為若成功，預期之淨虧損。</p>
                                            <p className="text-sm text-red-500 mt-2 italic">
                                                {singleBetLossSuggestions[Math.floor(Math.random() * singleBetLossSuggestions.length)]}
                                            </p>
                                        </>
                                    )}
                                </div>
                            )}

                            {/* Section for Target Profit Calculation */}
                            <div className="mt-6 p-6 bg-gray-100 rounded-xl shadow-inner text-center">
                                <h2 className="text-xl font-semibold text-gray-800 mb-4">目標獲利所需投注計算</h2>
                                <div className="mb-4">
                                    <label htmlFor="targetProfitAmount" className="block text-gray-700 text-sm font-semibold mb-2">
                                        目標獲利金額 (NTD):
                                    </label>
                                    <input
                                        type="number"
                                        id="targetProfitAmount"
                                        value={targetProfitAmount}
                                        onChange={(e) => setTargetProfitAmount(e.target.value)}
                                        placeholder="例如: 1000"
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                    />
                                </div>
                                {requiredBetForTargetProfit !== null && (
                                    <p className="text-lg font-bold text-gray-800 mt-4">
                                        為達到目標獲利，需投注:
                                        <span className="ml-2 text-purple-600 text-3xl">
                                            {requiredBetForTargetProfit} NTD
                                        </span>
                                    </p>
                                )}
                                {(parseFloat(odds) < 1.01 && targetProfitAmount !== '') && (
                                    <p className="text-red-500 text-sm mt-2">
                                        賠率過低 (接近1)，無法達到目標獲利，或需投注極大金額。
                                    </p>
                                )}
                            </div>

                        </div>

                        {/* Display area for the last 10 records (right side) */}
                        <div id="bet-history-section" className="bg-white p-8 rounded-xl shadow-2xl w-full md:w-3/5 overflow-y-auto max-h-[85vh] min-h-[200px]">
                            <h2 className="text-xl font-extrabold text-gray-900 mb-4 text-center">投注紀錄</h2>

                            {/* Date and Type filter inputs and Export/Print buttons */}
                            <div className="mb-4 flex flex-col sm:flex-row sm:space-x-4 items-end">
                                <div className="flex-1 mb-4 sm:mb-0">
                                    <label htmlFor="startDate" className="block text-gray-700 text-sm font-semibold mb-2">
                                        開始日期:
                                    </label>
                                    <input
                                        type="date"
                                        id="startDate"
                                        value={startDate}
                                        onChange={(e) => setStartDate(e.target.value)}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                    />
                                </div>
                                <div className="flex-1 mb-4 sm:mb-0">
                                    <label htmlFor="endDate" className="block text-gray-700 text-sm font-semibold mb-2">
                                        結束日期:
                                    </label>
                                    <input
                                        type="date"
                                        id="endDate"
                                        value={endDate}
                                        onChange={(e) => setEndDate(e.target.value)}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                    />
                                </div>
                                {/* Event Type Filter Dropdown */}
                                <div className="flex-1 mb-4 sm:mb-0">
                                    <label htmlFor="eventTypeFilter" className="block text-gray-700 text-sm font-semibold mb-2">
                                        賽事類型篩選:
                                    </label>
                                    <select
                                        id="eventTypeFilter"
                                        value={selectedEventTypeFilter}
                                        onChange={(e) => setSelectedEventTypeFilter(e.target.value)}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                    >
                                        <option value="">所有類型</option>
                                        {managedEventTypes.map(type => (
                                            type && <option key={type} value={type}>{type}</option>
                                        ))}
                                    </select>
                                </div>
                                {/* Play Type Filter Dropdown */}
                                <div className="flex-1 mb-4 sm:mb-0">
                                    <label htmlFor="playTypeFilter" className="block text-gray-700 text-sm font-semibold mb-2">
                                        玩法篩選:
                                    </label>
                                    <select
                                        id="playTypeFilter"
                                        value={selectedPlayTypeFilter}
                                        onChange={(e) => setSelectedPlayTypeFilter(e.target.value)}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800"
                                    >
                                        <option value="">所有玩法</option>
                                        {managedPlayTypes.map(type => (
                                            type && <option key={type} value={type}>{type}</option>
                                        ))}
                                    </select>
                                </div>

                                <button
                                    onClick={exportToCsv}
                                    className="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75 mb-2 sm:mb-0"
                                >
                                    導出紀錄
                                </button>
                                <button
                                    onClick={handlePrintRecordsOnly}
                                    className="w-full sm:w-auto bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75"
                                >
                                    列印紀錄
                                </button>
                            </div>

                            {filteredBetHistory.length > 0 ? (
                                <>
                                    <div className="overflow-x-auto">
                                        <table className="min-w-full bg-white rounded-lg shadow-md">
                                            <thead>
                                                <tr className="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                                                    <th className="py-3 px-6 text-left">序號</th>
                                                    <th className="py-3 px-6 text-left">日期時間</th>
                                                    <th className="py-3 px-6 text-left">賽事類型</th>
                                                    <th className="py-3 px-6 text-left">玩法</th>
                                                    <th className="py-3 px-6 text-left">金額</th>
                                                    <th className="py-3 px-6 text-left">賠率</th>
                                                    <th className="py-3 px-6 text-left">結果</th>
                                                    <th className="py-3 px-6 text-left">獲利/虧損</th>
                                                    <th className="py-3 px-6 text-left">操作</th>
                                                </tr>
                                            </thead>
                                            <tbody className="text-gray-600 text-sm font-light">
                                                {filteredBetHistory.map((record, index) => (
                                                    <tr key={record.id} className="border-b border-gray-200 hover:bg-gray-100">
                                                        <td className="py-3 px-6 text-left whitespace-nowrap">{index + 1}</td>
                                                        <td className="py-3 px-6 text-left whitespace-nowrap">{record.date}</td>
                                                        <td className="py-3 px-6 text-left whitespace-nowrap">{record.eventType}</td>
                                                        <td className="py-3 px-6 text-left whitespace-nowrap">{record.playType}</td>
                                                        <td className="py-3 px-6 text-left whitespace-nowrap">{record.betAmount}</td>
                                                        <td className="py-3 px-6 text-left">{record.odds}</td>
                                                        <td className="py-3 px-6 text-left">
                                                            {record.status === 'pending' ? (
                                                                <div className="flex space-x-2">
                                                                    <button
                                                                        onClick={() => updateBetStatus(record.id, 'win')}
                                                                        className="bg-green-500 hover:bg-green-600 text-white text-xs px-2 py-1 rounded-md transition duration-200"
                                                                        disabled={loadingFirebase || !isAuthReady}
                                                                    >
                                                                        贏
                                                                    </button>
                                                                    <button
                                                                        onClick={() => updateBetStatus(record.id, 'loss')}
                                                                        className="bg-red-500 hover:bg-red-600 text-white text-xs px-2 py-1 rounded-md transition duration-200"
                                                                        disabled={loadingFirebase || !isAuthReady}
                                                                    >
                                                                        輸
                                                                    </button>
                                                                </div>
                                                            ) : (
                                                                <span className={`px-2 py-1 font-semibold leading-tight rounded-full ${record.outcome === 'win' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                                                    {record.outcome === 'win' ? '贏' : '輸'}
                                                                </span>
                                                            )}
                                                        </td>
                                                        <td className={`py-3 px-6 text-left ${record.status === 'pending' ? 'text-gray-500' : (record.profitLoss >= 0 ? 'text-green-600' : 'text-red-600')}`}>
                                                            {record.status === 'pending' ? '待定' : record.profitLoss.toFixed(2)}
                                                        </td>
                                                        <td className="py-3 px-6 text-left">
                                                            <div className="flex space-x-2">
                                                                <button
                                                                    onClick={() => handleEditRecord(record)}
                                                                    className="bg-blue-500 hover:bg-blue-600 text-white text-xs px-2 py-1 rounded-md transition duration-200"
                                                                    disabled={loadingFirebase || !isAuthReady}
                                                                >
                                                                    編輯
                                                                </button>
                                                                <button
                                                                    onClick={() => { setShowConfirmDeleteDialog(true); setRecordToDelete(record.id); }}
                                                                    className="bg-gray-400 hover:bg-gray-500 text-white text-xs px-2 py-1 rounded-md transition duration-200"
                                                                    disabled={loadingFirebase || !isAuthReady}
                                                                >
                                                                    刪除
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div className="mt-4 text-center text-lg font-bold">
                                        篩選後總獲利/虧損:
                                        <span className={`ml-2 ${parseFloat(totalProfitLossFiltered) >= 0 ? 'text-blue-600' : 'text-red-600'}`}>
                                            {totalProfitLossFiltered} NTD
                                        </span>
                                    </div>
                                    {/* Win/Loss Counts and Average Win Rate */}
                                    <div className="mt-2 text-center text-base font-semibold text-gray-700">
                                        當日總投注金額: <span className="text-blue-700">{totalBetAmountFiltered} NTD</span> |
                                        總勝場: <span className="text-green-700">{totalWins}</span> |
                                        總敗場: <span className="text-red-700">{totalLosses}</span> |
                                        平均勝率: <span className="text-blue-700">{averageWinRate}%</span>
                                    </div>
                                    {/* New: 店家退水 */}
                                    <div className="mt-2 text-center text-base font-semibold text-gray-700">
                                        店家退水: <span className="text-blue-700">{(parseFloat(totalBetAmountFiltered) * (shopRebatePercentage / 100)).toFixed(2)} NTD</span>
                                    </div>
                                    {/* New: Event Type Counts Display */}
                                    {Object.keys(eventTypeCounts).length > 0 && (
                                        <div className="mt-2 text-center text-base font-semibold text-gray-700">
                                            {Object.entries(eventTypeCounts).map(([type, count]) => (
                                                <span key={type} className="mr-4">
                                                    {type}: <span className="text-blue-700">{count} 場</span>
                                                </span>
                                            ))}
                                        </div>
                                    )}
                                    {/* New: Play Type Counts Display */}
                                    {Object.keys(playTypeCounts).length > 0 && (
                                        <div className="mt-2 text-center text-base font-semibold text-gray-700">
                                            {Object.entries(playTypeCounts).map(([type, count]) => (
                                                <span key={type} className="mr-4">
                                                    {type} 玩法: <span className="text-blue-700">{count} 場</span>
                                                </span>
                                            ))}
                                        </div>
                                    )}
                                    {/* Conditional General advice for overall profit/loss */}
                                    <div className="mt-4 text-center text-sm text-gray-600 italic">
                                        {parseFloat(totalProfitLossFiltered) > 0 ? (
                                            generalProfitAdvice[Math.floor(Math.random() * generalProfitAdvice.length)]
                                        ) : parseFloat(totalProfitLossFiltered) < 0 ? (
                                            generalLossAdvice[Math.floor(Math.random() * generalLossAdvice.length)]
                                        ) : (
                                            generalNeutralAdvice[Math.floor(Math.random() * generalNeutralAdvice.length)]
                                        )}
                                    </div>
                                </>
                            ) : (
                                <p className="text-center text-gray-500 mt-8">
                                    沒有符合篩選條件的投注紀錄。
                                </p>
                            )}
                        </div>
                    </div>
                    {/* Copyright notice at the bottom */}
                    <div className="w-full text-center text-gray-600 text-sm mt-8 pb-4">
                        威爾設計版權所有 ver {currentVersion}
                        <button
                            onClick={() => setShowUpdateLogModal(true)}
                            className="ml-2 px-2 py-1 bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs rounded-full transition duration-200"
                        >
                            更新紀錄
                        </button>
                    </div>

                    {/* Update Log Modal */}
                    {showUpdateLogModal && (
                        <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4">
                            <div className="bg-white p-6 rounded-lg shadow-xl max-w-md w-full max-h-[80vh] overflow-y-auto">
                                <h2 className="text-2xl font-bold text-gray-900 mb-4 text-center">更新紀錄</h2>
                                {versionHistoryData.map((v, i) => (
                                    <div key={v.version} className={`mb-4 pb-4 ${i < versionHistoryData.length - 1 ? 'border-b border-gray-200' : ''}`}>
                                        <p className="text-lg font-semibold text-blue-700">版本: {v.version}</p>
                                        <p className="text-sm text-gray-500 mb-2">日期: {v.date}</p>
                                        <p className="text-gray-700">{v.content}</p>
                                    </div>
                                ))}
                                <div className="text-center mt-4">
                                    <button
                                        onClick={() => setShowUpdateLogModal(false)}
                                        className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200"
                                    >
                                        關閉
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Mount the React app to the root div
        const domContainer = document.querySelector('#root');
        const root = ReactDOM.createRoot(domContainer);
        root.render(<App />);
    </script>
</body>
</html>
